<!DOCTYPE html>
<html lang="km">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Invoice á‘á¹á€-á—áŸ’á›á¾á„ with Firebase Firestore</title>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

  <style>
    body {
      font-family: 'Khmer OS Battambang', sans-serif;
      margin: 10px;
      background: #f5f7fa;
      max-width: 700px;
      margin-left: auto;
      margin-right: auto;
      padding-bottom: 50px;
    }
    label, input, select, button {
      width: 100%;
      margin-top: 10px;
      font-size: 16px;
    }
    input, select {
      padding: 8px;
      border-radius: 6px;
      border: 1.5px solid #ccc;
      box-sizing: border-box;
    }
    button {
      padding: 12px;
      background: #1e88e5;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      margin-top: 20px;
      font-size: 16px;
    }
    button:hover {
      background: #1565c0;
    }
    table {
      width: 100%;
      margin-top: 20px;
      border-collapse: collapse;
      font-size: 14px;
    }
    th, td {
      padding: 8px;
      border: 1px solid #ccc;
      text-align: center;
    }
    th {
      background: #1e88e5;
      color: white;
    }
    .total {
      font-weight: bold;
      background-color: #e3f2fd;
    }
    .grand-total {
      font-weight: bold;
      text-align: right;
      margin-top: 20px;
      font-size: 16px;
      color: #2e7d32;
    }
    #login-section, #app-section {
      margin-top: 20px;
    }
    #login-section input {
      margin-bottom: 10px;
    }
    .hidden {
      display: none;
    }

    /* Mobile responsive */
    @media (max-width: 480px) {
      body {
        padding: 5px;
      }
      button, input, select, label {
        font-size: 14px;
      }
      th, td {
        font-size: 12px;
        padding: 6px;
      }
    }
  </style>
</head>
<body>

<h2>Invoice á‘á¹á€-á—áŸ’á›á¾á„</h2>

<!-- Login/Register Section -->
<div id="login-section">
  <h3>á…á¼á› / á…á»áŸ‡áˆáŸ’á˜áŸ„áŸ‡</h3>
  <input type="email" id="email" placeholder="á¢áŸŠá¸á˜áŸ‰áŸ‚á›" />
  <input type="password" id="password" placeholder="á–á¶á€áŸ’á™áŸá˜áŸ’á„á¶ááŸ‹" />
  <button onclick="login()">á…á¼á›</button>
  <button onclick="register()">á…á»áŸ‡áˆáŸ’á˜áŸ„áŸ‡</button>
  <p id="login-msg" style="color:red;"></p>
</div>

<!-- Main App Section (hidden initially) -->
<div id="app-section" class="hidden">
  <button style="background:#e53935; margin-bottom:15px;" onclick="logout()">á…á¶á€á…áŸá‰</button>

  <label>áá˜áŸ’á›áŸƒá‘á¹á€ (ášáŸ€á›/á™á¼á“á¸á)</label>
  <input type="number" id="water-price" value="3000" />

  <label>áá˜áŸ’á›áŸƒá—áŸ’á›á¾á„ (ášáŸ€á›/á‚á¸á¡á¼áœáŸ‰á¶ááŸ‹)</label>
  <input type="number" id="electric-price" value="4000" />

  <label>á”á“áŸ’á‘á”áŸ‹</label>
  <select id="room">
    <option value="">-- á‡áŸ’ášá¾áŸá”á“áŸ’á‘á”áŸ‹ --</option>
    <option value="1">á”á“áŸ’á‘á”áŸ‹ áŸ¡</option>
    <option value="2">á”á“áŸ’á‘á”áŸ‹ áŸ¢</option>
    <option value="3">á”á“áŸ’á‘á”áŸ‹ áŸ£</option>
    <option value="4">á”á“áŸ’á‘á”áŸ‹ áŸ¤</option>
  </select>

  <label>ááŸ‚</label>
  <input type="month" id="month" />

  <label>áˆáŸ’á˜áŸ„áŸ‡á¢áá·áá·á‡á“</label>
  <input type="text" id="customer-name" placeholder="á”á‰áŸ’á…á¼á›áˆáŸ’á˜áŸ„áŸ‡á¢áá·áá·á‡á“" />

  <label>á›áŸáá‘á¼ášáŸáŸá–áŸ’á‘</label>
  <input type="tel" id="customer-phone" placeholder="á”á‰áŸ’á…á¼á›á›áŸáá‘á¼ášáŸáŸá–áŸ’á‘" />

  <label>á‘á¹á€á…á¶áŸáŸ‹</label>
  <input type="number" id="water-old" />
  <label>á‘á¹á€ááŸ’á˜á¸</label>
  <input type="number" id="water-new" />
  <label>á—áŸ’á›á¾á„á…á¶áŸáŸ‹</label>
  <input type="number" id="electric-old" />
  <label>á—áŸ’á›á¾á„ááŸ’á˜á¸</label>
  <input type="number" id="electric-new" />

  <button onclick="saveData()">ášá€áŸ’áŸá¶á‘á»á€</button>

  <h3>á”áŸ’ášáœááŸ’áá·áœá·á€áŸ’á€á™á”ááŸ’áš</h3>
  <label>á”á„áŸ’á á¶á‰ááŸ‚á”á“áŸ’á‘á”áŸ‹:</label>
  <select id="filter-room" onchange="loadData()">
    <option value="">-- á”á„áŸ’á á¶á‰á‘á¶áŸ†á„á¢áŸáŸ‹ --</option>
    <option value="1">á”á“áŸ’á‘á”áŸ‹ áŸ¡</option>
    <option value="2">á”á“áŸ’á‘á”áŸ‹ áŸ¢</option>
    <option value="3">á”á“áŸ’á‘á”áŸ‹ áŸ£</option>
    <option value="4">á”á“áŸ’á‘á”áŸ‹ áŸ¤</option>
  </select>

  <table>
    <thead>
      <tr>
        <th>á›áŸááœá·á€áŸ’á€á™á”ááŸ’áš</th>
        <th>á¢áá·áá·á‡á“</th>
        <th>á”á“áŸ’á‘á”áŸ‹</th>
        <th>ááŸ‚</th>
        <th>á€á¶á›á”ášá·á…áŸ’á†áŸá‘</th>
        <th>á”áŸ„áŸ‡á–á»á˜áŸ’á–</th>
      </tr>
    </thead>
    <tbody id="history-tbody"></tbody>
  </table>
</div>

<script>
  // Firebase Config
  const firebaseConfig = {
    apiKey: "AIzaSyBt_ScEi_StJ0wQDP-gZwMWmy5A7HqEcXE",
    authDomain: "invoice-77616.firebaseapp.com",
    projectId: "invoice-77616",
    storageBucket: "invoice-77616.appspot.com",
    messagingSenderId: "91579214593",
    appId: "1:91579214593:web:eca7aad598915de58ec900",
    measurementId: "G-99K8KQ02M0"
  };

  // Initialize Firebase
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  // Show/hide sections
  auth.onAuthStateChanged(user => {
    if (user) {
      document.getElementById('login-section').classList.add('hidden');
      document.getElementById('app-section').classList.remove('hidden');
      loadData();
    } else {
      document.getElementById('login-section').classList.remove('hidden');
      document.getElementById('app-section').classList.add('hidden');
    }
  });

  // Login
  function login() {
    const email = document.getElementById('email').value.trim();
    const password = document.getElementById('password').value.trim();
    const msg = document.getElementById('login-msg');
    msg.textContent = '';

    if (!email || !password) {
      msg.textContent = 'áŸá¼á˜á”á‰áŸ’á…á¼á›á¢áŸŠá¸á˜áŸ‰áŸ‚á› á“á·á„ á–á¶á€áŸ’á™áŸá˜áŸ’á„á¶ááŸ‹';
      return;
    }

    auth.signInWithEmailAndPassword(email, password)
      .then(() => {
        msg.textContent = '';
      })
      .catch(err => {
        msg.textContent = 'á€áŸ†á á»áŸá…á¼á›: ' + err.message;
      });
  }

  // Register
  function register() {
    const email = document.getElementById('email').value.trim();
    const password = document.getElementById('password').value.trim();
    const msg = document.getElementById('login-msg');
    msg.textContent = '';

    if (!email || !password) {
      msg.textContent = 'áŸá¼á˜á”á‰áŸ’á…á¼á›á¢áŸŠá¸á˜áŸ‰áŸ‚á› á“á·á„ á–á¶á€áŸ’á™áŸá˜áŸ’á„á¶ááŸ‹';
      return;
    }

    auth.createUserWithEmailAndPassword(email, password)
      .then(() => {
        msg.textContent = 'á”á¶á“á…á»áŸ‡áˆáŸ’á˜áŸ„áŸ‡á‡áŸ„á‚á‡áŸá™! áŸá¼á˜á…á¼á›á”áŸ’ášá¾.';
      })
      .catch(err => {
        msg.textContent = 'á€áŸ†á á»áŸá…á»áŸ‡áˆáŸ’á˜áŸ„áŸ‡: ' + err.message;
      });
  }

  // Logout
  function logout() {
    auth.signOut();
  }

  // Generate invoice number
  function generateInvoiceNumber(room, month) {
    const ym = month.replace('-', '');
    const randomSuffix = Math.floor(Math.random() * 900 + 100);
    return `INV-${ym}-${room}-${randomSuffix}`;
  }

  // Save invoice
  async function saveData() {
    const room = document.getElementById('room').value;
    const month = document.getElementById('month').value;
    const waterOld = parseInt(document.getElementById('water-old').value);
    const waterNew = parseInt(document.getElementById('water-new').value);
    const electricOld = parseInt(document.getElementById('electric-old').value);
    const electricNew = parseInt(document.getElementById('electric-new').value);
    const customerName = document.getElementById('customer-name').value.trim();
    const customerPhone = document.getElementById('customer-phone').value.trim();

    if (!room || !month || isNaN(waterOld) || isNaN(waterNew) || isNaN(electricOld) || isNaN(electricNew) || !customerName || !customerPhone) {
      alert('áŸá¼á˜á”áŸ†á–áŸá‰á‘á·á“áŸ’á“á“áŸá™á‘á¶áŸ†á„á¢áŸáŸ‹');
      return;
    }

    const invoiceNo = generateInvoiceNumber(room, month);

    try {
      await db.collection('invoices').doc(invoiceNo).set({
        room,
        month,
        waterOld,
        waterNew,
        electricOld,
        electricNew,
        customerName,
        customerPhone,
        invoiceNo,
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      });
      alert('âœ… á”á¶á“ášá€áŸ’áŸá¶á‘á»á€á‘áŸ… Firebase!');
      loadData();
      clearForm();
    } catch (error) {
      alert('âŒ á€áŸ†á á»áŸ: ' + error.message);
    }
  }

  // Load invoice history with filter
  async function loadData() {
    const tbody = document.getElementById('history-tbody');
    tbody.innerHTML = '';
    const filterRoom = document.getElementById('filter-room').value;

    let query = db.collection('invoices').orderBy('timestamp', 'desc');

    if (filterRoom) {
      query = query.where('room', '==', filterRoom);
    }

    try {
      const snapshot = await query.get();
      if (snapshot.empty) {
        tbody.innerHTML = `<tr><td colspan="6">á˜á·á“á˜á¶á“á‘á·á“áŸ’á“á“áŸá™</td></tr>`;
        return;
      }

      snapshot.forEach(doc => {
        const d = doc.data();
        const date = d.timestamp ? new Date(d.timestamp.seconds * 1000).toLocaleString('km-KH') : '';
        const row = document.createElement('tr');

        row.innerHTML = `
          <td>${d.invoiceNo}</td>
          <td>${d.customerName}</td>
          <td>${d.room}</td>
          <td>${d.month}</td>
          <td>${date}</td>
          <td><button onclick="printOldInvoice('${doc.id}')">ğŸ–¨ï¸ á”áŸ„áŸ‡á–á»á˜áŸ’á–</button></td>
        `;
        tbody.appendChild(row);
      });
    } catch (error) {
      alert('âŒ á€áŸ†á á»áŸá€áŸ’á“á»á„á€á¶ášá‘á¶á‰á‘á·á“áŸ’á“á“áŸá™: ' + error.message);
    }
  }

  // Clear input form
  function clearForm() {
    document.getElementById('room').value = '';
    document.getElementById('month').value = '';
    document.getElementById('water-old').value = '';
    document.getElementById('water-new').value = '';
    document.getElementById('electric-old').value = '';
    document.getElementById('electric-new').value = '';
    document.getElementById('customer-name').value = '';
    document.getElementById('customer-phone').value = '';
  }

  // Print old invoice
  async function printOldInvoice(docId) {
    try {
      const doc = await db.collection('invoices').doc(docId).get();
      if (!doc.exists) {
        alert('á˜á·á“áƒá¾á‰áœá·á€áŸ’á€á™á”ááŸ’ášá“áŸáŸ‡!');
        return;
      }
      const d = doc.data();

      const waterPrice = parseInt(document.getElementById('water-price').value) || 0;
      const electricPrice = parseInt(document.getElementById('electric-price').value) || 0;

      const waterUsed = d.waterNew - d.waterOld;
      const electricUsed = d.electricNew - d.electricOld;
      const waterCost = waterUsed * waterPrice;
      const electricCost = electricUsed * electricPrice;
      const total = waterCost + electricCost;

      const printContent = `
        <style>
          body { font-family: 'Khmer OS Battambang', sans-serif; margin: 20px; background: #f5f7fa; color: #333; }
          h1 { text-align: center; color: #1e88e5; margin-bottom: 10px; }
          p { margin: 3px 0; font-size: 14px; }
          table { width: 100%; border-collapse: collapse; font-size: 14px; margin-top: 15px; }
          th, td { border: 1px solid #ccc; padding: 10px; text-align: center; }
          th { background-color: #1e88e5; color: white; }
          .total { font-weight: bold; background-color: #e3f2fd; }
          .grand-total { font-weight: bold; text-align: right; margin-top: 20px; font-size: 16px; color: #2e7d32; }
        </style>

        <h1>áœá·á€áŸ’á€á™á”ááŸ’áš á‘á¹á€-á—áŸ’á›á¾á„</h1>
        <p><strong>á›áŸááœá·á€áŸ’á€á™á”ááŸ’áš:</strong> ${d.invoiceNo}</p>
        <p><strong>á”á“áŸ’á‘á”áŸ‹:</strong> ${d.room} | <strong>ááŸ‚:</strong> ${d.month}</p>
        <p><strong>á¢áá·áá·á‡á“:</strong> ${d.customerName}</p>
        <p><strong>á›áŸáá‘á¼ášáŸáŸá–áŸ’á‘:</strong> ${d.customerPhone}</p>

        <table>
          <thead>
            <tr><th>á…á¶áŸáŸ‹</th><th>ááŸ’á˜á¸</th><th>á”áŸ’ášá¾</th><th>áá˜áŸ’á›áŸƒ</th><th>ááŸ’á›áŸƒ</th></tr>
          </thead>
          <tbody>
            <tr>
              <td>${d.waterOld}</td>
              <td>${d.waterNew}</td>
              <td>${waterUsed}</td>
              <td>${waterPrice.toLocaleString()}</td>
              <td>${waterCost.toLocaleString()} ášáŸ€á›</td>
            </tr>
            <tr class="total">
              <td colspan="4">áŸášá»á”á‘á¹á€</td>
              <td>${waterCost.toLocaleString()} ášáŸ€á›</td>
            </tr>
          </tbody>
        </table>

        <table>
          <thead>
            <tr><th>á…á¶áŸáŸ‹</th><th>ááŸ’á˜á¸</th><th>á”áŸ’ášá¾</th><th>áá˜áŸ’á›áŸƒ</th><th>ááŸ’á›áŸƒ</th></tr>
          </thead>
          <tbody>
            <tr>
              <td>${d.electricOld}</td>
              <td>${d.electricNew}</td>
              <td>${electricUsed}</td>
              <td>${electricPrice.toLocaleString()}</td>
              <td>${electricCost.toLocaleString()} ášáŸ€á›</td>
            </tr>
            <tr class="total">
              <td colspan="4">áŸášá»á”á—áŸ’á›á¾á„</td>
              <td>${electricCost.toLocaleString()} ášáŸ€á›</td>
            </tr>
          </tbody>
        </table>

        <p class="grand-total">áŸášá»á”á…á»á„á€áŸ’ášáŸ„á™: ${total.toLocaleString()} ášáŸ€á›</p>
      `;

      const win = window.open('', '', 'width=800,height=900');
      win.document.write(`
        <html>
          <head>
            <title>Print Invoice</title>
            <style>@media print {
              body { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
              th { background-color: #1e88e5 !important; color: white !important; }
              .total { background-color: #e3f2fd !important; }
              .grand-total { color: #2e7d32 !important; }
            }</style>
          </head>
          <body onload="window.print(); window.close();">${printContent}</body>
        </html>
      `);
      win.document.close();

    } catch (error) {
      alert('á€áŸ†á á»áŸá€áŸ’á“á»á„á€á¶ášá‘á¶á‰ á“á·á„á”áŸ„áŸ‡á–á»á˜áŸ’á–: ' + error.message);
    }
  }
</script>

</body>
</html>
